name: Daily Business Intelligence Report

on:
  schedule:
    - cron: '0 18 * * *'   # 7am NZDT (summer Oct-Mar)
  workflow_dispatch:
    inputs:
      business:
        description: 'Which business (leave blank for both)'
        required: false
        default: 'noody'

jobs:
  daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install
      - name: Create Google credentials
        run: |
          mkdir -p credentials
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}' > credentials/google-sa.json
      - name: Run daily report
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SHOPIFY_NOODY_STORE: ${{ secrets.SHOPIFY_NOODY_STORE }}
          SHOPIFY_NOODY_TOKEN: ${{ secrets.SHOPIFY_NOODY_TOKEN }}
          SHOPIFY_NOODY_CLIENT_ID: ${{ secrets.SHOPIFY_NOODY_CLIENT_ID }}
          SHOPIFY_NOODY_CLIENT_SECRET: ${{ secrets.SHOPIFY_NOODY_CLIENT_SECRET }}
          META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
          META_NOODY_AD_ACCOUNT: ${{ secrets.META_NOODY_AD_ACCOUNT }}
          IG_NOODY_ACCOUNT_ID: ${{ secrets.IG_NOODY_ACCOUNT_ID }}
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          FB_NOODY_PAGE_ID: ${{ secrets.FB_NOODY_PAGE_ID }}
          FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
          GOOGLE_ADS_CLIENT_ID: ${{ secrets.GOOGLE_ADS_CLIENT_ID }}
          GOOGLE_ADS_CLIENT_SECRET: ${{ secrets.GOOGLE_ADS_CLIENT_SECRET }}
          GOOGLE_ADS_REFRESH_TOKEN: ${{ secrets.GOOGLE_ADS_REFRESH_TOKEN }}
          GOOGLE_ADS_DEVELOPER_TOKEN: ${{ secrets.GOOGLE_ADS_DEVELOPER_TOKEN }}
          GOOGLE_ADS_NOODY_CUSTOMER_ID: ${{ secrets.GOOGLE_ADS_NOODY_CUSTOMER_ID }}
          GOOGLE_APPLICATION_CREDENTIALS: ./credentials/google-sa.json
          GA4_NOODY_PROPERTY_ID: ${{ secrets.GA4_NOODY_PROPERTY_ID }}
          KLAVIYO_API_KEY: ${{ secrets.KLAVIYO_API_KEY }}
          XERO_CLIENT_ID: ${{ secrets.XERO_CLIENT_ID }}
          XERO_CLIENT_SECRET: ${{ secrets.XERO_CLIENT_SECRET }}
          XERO_REFRESH_TOKEN: ${{ secrets.XERO_REFRESH_TOKEN }}
          XERO_NOODY_TENANT_ID: ${{ secrets.XERO_NOODY_TENANT_ID }}
          UNLEASHED_API_ID: ${{ secrets.UNLEASHED_API_ID }}
          UNLEASHED_API_KEY: ${{ secrets.UNLEASHED_API_KEY }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_NOODY_CHANNEL: ${{ secrets.SLACK_NOODY_CHANNEL }}
          SLACK_COMBINED_CHANNEL: ${{ secrets.SLACK_COMBINED_CHANNEL }}
          SLACK_ECOMMERCE_CHANNEL: ${{ secrets.SLACK_ECOMMERCE_CHANNEL }}
          SLACK_PPC_CHANNEL: ${{ secrets.SLACK_PPC_CHANNEL }}
          SLACK_MARKETING_CHANNEL: ${{ secrets.SLACK_MARKETING_CHANNEL }}
          SLACK_SOCIAL_CHANNEL: ${{ secrets.SLACK_SOCIAL_CHANNEL }}
          SLACK_FINANCE_CHANNEL: ${{ secrets.SLACK_FINANCE_CHANNEL }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
        run: |
          if [ "${{ github.event.inputs.business }}" = "noody" ]; then
            npm run noody
          elif [ "${{ github.event.inputs.business }}" = "facialist" ]; then
            npm run facialist
          else
            npm start
          fi
      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.SLACK_COMBINED_CHANNEL }}
          slack-message: "ðŸš¨ Daily report failed! Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
